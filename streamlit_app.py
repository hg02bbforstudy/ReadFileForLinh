import streamlit as st
import pandas as pd
import tempfile
import os
from datetime import datetime
import json
import base64

# Import the CV processor
from cv_processor_api import CVProcessor

# Streamlit page config
st.set_page_config(
    page_title="üêç CV Reader - Streamlit Edition",
    page_icon="üìÑ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .metric-card {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        margin: 0.5rem 0;
    }
    
    .confidence-high { color: #28a745; font-weight: bold; }
    .confidence-medium { color: #ffc107; font-weight: bold; }
    .confidence-low { color: #dc3545; font-weight: bold; }
    
    .stProgress > div > div > div > div {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>
""", unsafe_allow_html=True)

# Initialize processor
@st.cache_resource
def get_cv_processor():
    return CVProcessor()

cv_processor = get_cv_processor()

# Header
st.markdown("""
<div class="main-header">
    <h1>üêç CV Reader - Streamlit Edition</h1>
    <p>Tr√≠ch xu·∫•t th√¥ng tin CV v·ªõi Python & AI - Giao di·ªán th√¢n thi·ªán</p>
    <small>‚ú® DOCX Advanced ‚Ä¢ PDF Deep Analysis ‚Ä¢ OCR Support ‚Ä¢ Vietnamese NLP</small>
</div>
""", unsafe_allow_html=True)

# Sidebar
with st.sidebar:
    st.header("‚öôÔ∏è C·∫•u h√¨nh")
    
    # Processing options
    st.subheader("üìä T√πy ch·ªçn x·ª≠ l√Ω")
    use_nlp = st.checkbox("ü§ñ S·ª≠ d·ª•ng NLP", value=True, help="TƒÉng ƒë·ªô ch√≠nh x√°c cho t√™n, c√¥ng ty")
    use_advanced_extraction = st.checkbox("üîç Tr√≠ch xu·∫•t n√¢ng cao", value=True)
    confidence_threshold = st.slider("üéØ Ng∆∞·ª°ng tin c·∫≠y", 0.0, 1.0, 0.5, 0.1)
    
    st.divider()
    
    # Export options
    st.subheader("üì• Xu·∫•t d·ªØ li·ªáu")
    export_format = st.selectbox("Format", ["CSV", "JSON", "Excel"])
    
    st.divider()
    
    # Statistics
    st.subheader("üìà Th·ªëng k√™")
    if 'processed_count' not in st.session_state:
        st.session_state.processed_count = 0
    
    st.metric("CV ƒë√£ x·ª≠ l√Ω", st.session_state.processed_count)
    
    # Clear data
    if st.button("üóëÔ∏è X√≥a d·ªØ li·ªáu", type="secondary"):
        for key in ['cv_data', 'results_history']:
            if key in st.session_state:
                del st.session_state[key]
        st.success("ƒê√£ x√≥a d·ªØ li·ªáu!")

# Main content
col1, col2 = st.columns([1, 2])

with col1:
    st.header("üìÑ Upload CV")
    
    # File uploader
    uploaded_file = st.file_uploader(
        "Ch·ªçn file CV",
        type=['pdf', 'docx'],
        help="H·ªó tr·ª£ file PDF v√† DOCX, t·ªëi ƒëa 10MB"
    )
    
    # Camera capture (placeholder)
    if st.button("üì∑ Ch·ª•p ·∫£nh CV", type="secondary"):
        st.info("T√≠nh nƒÉng ch·ª•p ·∫£nh s·∫Ω ƒë∆∞·ª£c h·ªó tr·ª£ trong phi√™n b·∫£n web app ƒë·∫ßy ƒë·ªß")
    
    # Process button
    if uploaded_file is not None:
        if st.button("üöÄ X·ª≠ l√Ω CV", type="primary"):
            with st.spinner("ƒêang x·ª≠ l√Ω CV v·ªõi Python AI..."):
                try:
                    # Save uploaded file temporarily
                    with tempfile.NamedTemporaryFile(delete=False, suffix=f".{uploaded_file.name.split('.')[-1]}") as tmp_file:
                        tmp_file.write(uploaded_file.getvalue())
                        tmp_file_path = tmp_file.name
                    
                    # Extract text
                    if uploaded_file.name.lower().endswith('.docx'):
                        text, extraction_confidence = cv_processor.extract_text_from_docx(tmp_file_path)
                    elif uploaded_file.name.lower().endswith('.pdf'):
                        text, extraction_confidence = cv_processor.extract_text_from_pdf(tmp_file_path)
                    
                    # Extract fields
                    fields, confidence = cv_processor.extract_fields(text)
                    
                    # Adjust confidence
                    for key in confidence:
                        confidence[key] *= extraction_confidence
                    
                    # Store results
                    st.session_state.cv_data = {
                        'fields': fields,
                        'confidence': confidence,
                        'raw_content': text,
                        'filename': uploaded_file.name,
                        'processing_time': datetime.now().isoformat(),
                        'extraction_confidence': extraction_confidence
                    }
                    
                    st.session_state.processed_count += 1
                    
                    # Clean up
                    os.unlink(tmp_file_path)
                    
                    st.success(f"‚úÖ X·ª≠ l√Ω th√†nh c√¥ng! ƒê·ªô tin c·∫≠y: {extraction_confidence:.1%}")
                    
                except Exception as e:
                    st.error(f"‚ùå L·ªói x·ª≠ l√Ω: {str(e)}")

with col2:
    st.header("üìä K·∫øt qu·∫£ tr√≠ch xu·∫•t")
    
    if 'cv_data' in st.session_state:
        cv_data = st.session_state.cv_data
        
        # Overview metrics
        st.subheader("üìà T·ªïng quan")
        col_metrics = st.columns(4)
        
        avg_confidence = sum(cv_data['confidence'].values()) / len(cv_data['confidence'])
        high_conf_fields = sum(1 for c in cv_data['confidence'].values() if c > 0.7)
        total_fields = len(cv_data['confidence'])
        
        with col_metrics[0]:
            st.metric("ƒê·ªô tin c·∫≠y TB", f"{avg_confidence:.1%}")
        with col_metrics[1]:
            st.metric("Tr∆∞·ªùng tin c·∫≠y cao", f"{high_conf_fields}/{total_fields}")
        with col_metrics[2]:
            st.metric("ƒê·ªô tin c·∫≠y tr√≠ch xu·∫•t", f"{cv_data['extraction_confidence']:.1%}")
        with col_metrics[3]:
            st.metric("Th·ªùi gian x·ª≠ l√Ω", "< 2s")
        
        st.divider()
        
        # Detailed results
        st.subheader("üìã Chi ti·∫øt k·∫øt qu·∫£")
        
        field_labels = {
            'name': 'üë§ H·ªç t√™n',
            'email': 'üìß Email',
            'phone': 'üìû S·ªë ƒëi·ªán tho·∫°i',
            'dob': 'üéÇ Ng√†y sinh',
            'gender': '‚ö• Gi·ªõi t√≠nh',
            'education': 'üéì H·ªçc v·∫•n',
            'school': 'üè´ Tr∆∞·ªùng h·ªçc',
            'major': 'üìö Chuy√™n ng√†nh',
            'currentPosition': 'üíº V·ªã tr√≠ hi·ªán t·∫°i',
            'experience': '‚ö° Kinh nghi·ªám',
            'appliedPosition': 'üéØ V·ªã tr√≠ ·ª©ng tuy·ªÉn'
        }
        
        # Editable form
        with st.form("edit_cv_data"):
            edited_fields = {}
            
            for field, value in cv_data['fields'].items():
                if field in field_labels:
                    conf = cv_data['confidence'][field]
                    
                    # Confidence indicator
                    if conf > 0.7:
                        conf_class = "confidence-high"
                        conf_icon = "üü¢"
                    elif conf > 0.4:
                        conf_class = "confidence-medium"
                        conf_icon = "üü°"
                    else:
                        conf_class = "confidence-low"
                        conf_icon = "üî¥"
                    
                    col_field, col_conf = st.columns([3, 1])
                    
                    with col_field:
                        edited_fields[field] = st.text_input(
                            field_labels[field],
                            value=value or '',
                            key=f"field_{field}"
                        )
                    
                    with col_conf:
                        st.markdown(f"""
                        <div class="metric-card">
                            {conf_icon} <span class="{conf_class}">{conf:.1%}</span>
                        </div>
                        """, unsafe_allow_html=True)
            
            # Update button
            if st.form_submit_button("üíæ C·∫≠p nh·∫≠t", type="primary"):
                st.session_state.cv_data['fields'].update(edited_fields)
                st.success("‚úÖ ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu!")
                st.rerun()
        
        st.divider()
        
        # Export section
        st.subheader("üì• Xu·∫•t d·ªØ li·ªáu")
        
        export_cols = st.columns(3)
        
        with export_cols[0]:
            if st.button("üìä Xu·∫•t CSV"):
                df = pd.DataFrame([cv_data['fields']])
                csv = df.to_csv(index=False)
                st.download_button(
                    label="‚¨áÔ∏è T·∫£i CSV",
                    data=csv,
                    file_name=f"cv_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                    mime="text/csv"
                )
        
        with export_cols[1]:
            if st.button("üìÑ Xu·∫•t JSON"):
                json_data = json.dumps(cv_data, ensure_ascii=False, indent=2)
                st.download_button(
                    label="‚¨áÔ∏è T·∫£i JSON",
                    data=json_data,
                    file_name=f"cv_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json",
                    mime="application/json"
                )
        
        with export_cols[2]:
            if st.button("üìà Xu·∫•t Excel"):
                df = pd.DataFrame([cv_data['fields']])
                # Convert to Excel
                excel_buffer = tempfile.NamedTemporaryFile(suffix='.xlsx', delete=False)
                df.to_excel(excel_buffer.name, index=False, engine='openpyxl')
                
                with open(excel_buffer.name, 'rb') as f:
                    st.download_button(
                        label="‚¨áÔ∏è T·∫£i Excel",
                        data=f.read(),
                        file_name=f"cv_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    )
                
                os.unlink(excel_buffer.name)
        
        # Raw content (collapsible)
        with st.expander("üìù N·ªôi dung g·ªëc"):
            st.text_area(
                "Raw text",
                value=cv_data['raw_content'][:2000] + ('...' if len(cv_data['raw_content']) > 2000 else ''),
                height=200,
                disabled=True
            )
    
    else:
        st.info("üëÜ Vui l√≤ng upload v√† x·ª≠ l√Ω file CV ƒë·ªÉ xem k·∫øt qu·∫£")
        
        # Sample data visualization
        st.subheader("üìä Demo v·ªõi d·ªØ li·ªáu m·∫´u")
        
        sample_data = {
            'Tr∆∞·ªùng': ['H·ªç t√™n', 'Email', 'S·ªë ƒêT', 'H·ªçc v·∫•n', 'Kinh nghi·ªám'],
            'ƒê·ªô tin c·∫≠y': [0.95, 0.88, 0.92, 0.76, 0.83],
            'Tr·∫°ng th√°i': ['üü¢ Cao', 'üü¢ Cao', 'üü¢ Cao', 'üü° Trung b√¨nh', 'üü¢ Cao']
        }
        
        df_sample = pd.DataFrame(sample_data)
        st.dataframe(df_sample, use_container_width=True)
        
        # Confidence chart
        st.bar_chart(df_sample.set_index('Tr∆∞·ªùng')['ƒê·ªô tin c·∫≠y'])

# Footer
st.divider()
st.markdown("""
<div style="text-align: center; color: #666; padding: 2rem;">
    <p>üêç <strong>CV Reader - Python Edition</strong></p>
    <p>Powered by Streamlit ‚Ä¢ Python ‚Ä¢ NLP ‚Ä¢ OCR</p>
    <p><small>¬© 2025 - Phi√™n b·∫£n n√¢ng cao v·ªõi ƒë·ªô ch√≠nh x√°c cao</small></p>
</div>
""", unsafe_allow_html=True)