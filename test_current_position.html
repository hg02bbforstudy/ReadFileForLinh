<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Test V·ªã Tr√≠ Hi·ªán T·∫°i</title>
</head>
<body>
    <h1>üß™ Test V·ªã Tr√≠ Hi·ªán T·∫°i</h1>
    <button onclick="testCurrentPosition()">Test Current Position</button>
    <div id="results"></div>

    <script>
        // Mock data for testing
        const testCvInfo = {
            personal: {name: "PH·∫†M Y·∫æN LINH"},
            contact: {email: "test@example.com"},
            education: [],
            experience: [
                {
                    timeRange: "01/2023 - nay",
                    position: "Marketing Manager",
                    company: "ABC Company", 
                    description: "Marketing Manager - ABC Company",
                    isCurrent: true,
                    raw: "01/2023 - nay: Marketing Manager - ABC Company"
                },
                {
                    timeRange: "06/2021 - 12/2022",
                    position: "Marketing Executive", 
                    company: "XYZ Corp",
                    description: "Marketing Executive - XYZ Corp", 
                    isCurrent: false,
                    raw: "06/2021 - 12/2022: Marketing Executive - XYZ Corp"
                }
            ]
        };

        function guessCurrentPosition(cvInfo) {
            console.log('=== DETERMINING CURRENT POSITION ===');
            console.log('Raw experience data:', cvInfo.experience);
            
            if (!Array.isArray(cvInfo.experience) || cvInfo.experience.length === 0) {
                console.log('‚ùå No experience data available');
                return '';
            }
            
            console.log(`Total experience entries: ${cvInfo.experience.length}`);
            
            // Debug t·ª´ng entry
            cvInfo.experience.forEach((exp, idx) => {
                console.log(`Experience ${idx + 1}:`, {
                    type: typeof exp,
                    timeRange: exp?.timeRange,
                    position: exp?.position,
                    company: exp?.company,
                    isCurrent: exp?.isCurrent,
                    raw: exp?.raw || exp
                });
            });
            
            // S·∫Øp x·∫øp experience theo th·ªùi gian ƒë·ªÉ t√¨m c√¥ng vi·ªác cu·ªëi c√πng
            let structuredExperiences = cvInfo.experience.filter(exp => 
                typeof exp === 'object' && exp !== null && exp.timeRange
            );
            
            console.log(`Filtered structured experiences: ${structuredExperiences.length}`);
            console.log('Structured experience details:', structuredExperiences);
            
            if (structuredExperiences.length > 0) {
                // S·∫Øp x·∫øp theo th·ªùi gian b·∫Øt ƒë·∫ßu (m·ªõi nh·∫•t tr∆∞·ªõc)
                structuredExperiences.sort((a, b) => {
                    const getStartTime = (exp) => {
                        const match = exp.timeRange.match(/(\d{1,2})\/(\d{4})/);
                        if (match) {
                            const year = parseInt(match[2]);
                            const month = parseInt(match[1]);
                            const time = year * 12 + month;
                            console.log(`Time calculation for "${exp.timeRange}": ${year}/${month} = ${time}`);
                            return time;
                        } else {
                            console.log(`‚ö†Ô∏è Could not parse time from: "${exp.timeRange}"`);
                            return 0;
                        }
                    };
                    const timeA = getStartTime(a);
                    const timeB = getStartTime(b);
                    console.log(`Comparing ${a.timeRange} (${timeA}) vs ${b.timeRange} (${timeB})`);
                    return timeB - timeA; // Newer first
                });
                
                console.log('‚úì Experiences sorted by time:');
                structuredExperiences.forEach((exp, idx) => {
                    console.log(`  ${idx + 1}. ${exp.timeRange} - ${exp.position} (isCurrent: ${exp.isCurrent})`);
                });
                
                // Ki·ªÉm tra c√¥ng vi·ªác m·ªõi nh·∫•t c√≥ ph·∫£i l√† current kh√¥ng
                const latestJob = structuredExperiences[0];
                console.log(`Latest job analysis:`, {
                    timeRange: latestJob?.timeRange,
                    position: latestJob?.position,
                    isCurrent: latestJob?.isCurrent,
                    currentCheck: latestJob && latestJob.isCurrent === true
                });
                
                let currentPosition = '';
                
                if (latestJob && latestJob.isCurrent === true) {
                    // ∆Øu ti√™n position field, fallback to parsing description
                    currentPosition = latestJob.position || 
                                    (latestJob.description ? latestJob.description.split('-')[0].trim() : '');
                    
                    console.log(`‚úÖ Latest job is CURRENT: ${latestJob.timeRange}`);
                    console.log(`   - Position field: "${latestJob.position}"`);
                    console.log(`   - Description: "${latestJob.description}"`);
                    console.log(`   - Final current position: "${currentPosition}"`);
                } else {
                    console.log(`‚ùå Latest job (${latestJob?.timeRange}) is NOT current, leaving position EMPTY`);
                    console.log(`   - isCurrent value: ${latestJob?.isCurrent}`);
                    console.log(`   - isCurrent type: ${typeof latestJob?.isCurrent}`);
                    console.log(`   - Latest job details:`, latestJob);
                    
                    // ADDITIONAL CHECK: Maybe isCurrent is string "true" or similar
                    if (latestJob && (String(latestJob.isCurrent).toLowerCase() === 'true' || 
                                     /nay|hi·ªán t·∫°i/i.test(latestJob.timeRange))) {
                        console.log(`üîÑ FALLBACK: Detecting current job from timeRange or string isCurrent`);
                        currentPosition = latestJob.position || 
                                        (latestJob.description ? latestJob.description.split('-')[0].trim() : '');
                        console.log(`   - FALLBACK current position: "${currentPosition}"`);
                    }
                }
                
                return currentPosition;
            } else {
                console.log('‚ùå No structured experiences found');
                return '';
            }
        }

        function testCurrentPosition() {
            console.log('üß™ Testing Current Position Logic...');
            const result = guessCurrentPosition(testCvInfo);
            
            document.getElementById('results').innerHTML = `
                <h2>Test Results:</h2>
                <p><strong>Current Position:</strong> "${result}"</p>
                <p><strong>Expected:</strong> "Marketing Manager"</p>
                <p><strong>Status:</strong> ${result === 'Marketing Manager' ? '‚úÖ PASS' : '‚ùå FAIL'}</p>
                
                <h3>Test Data:</h3>
                <pre>${JSON.stringify(testCvInfo.experience, null, 2)}</pre>
                
                <p><em>Check console for detailed logs</em></p>
            `;
        }
    </script>
</body>
</html>