<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Applied Positions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <h1>Debug Applied Positions Extraction</h1>
    
    <input type="file" id="fileInput" accept=".docx,.pdf">
    <br><br>
    
    <h2>Debug Output:</h2>
    <pre id="debugOutput" style="background: #f0f0f0; padding: 10px; white-space: pre-wrap;"></pre>
    
    <h2>Raw Text:</h2>
    <textarea id="rawText" style="width: 100%; height: 300px;"></textarea>

    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const debugOutput = document.getElementById('debugOutput');
            const rawTextArea = document.getElementById('rawText');
            
            debugOutput.textContent = 'Processing file...';
            
            try {
                let text = '';
                
                if (file.name.toLowerCase().endsWith('.docx')) {
                    const result = await mammoth.extractRawText({ 
                        arrayBuffer: await file.arrayBuffer() 
                    });
                    text = result.value;
                } else if (file.name.toLowerCase().endsWith('.pdf')) {
                    text = await extractTextFromPDF(file);
                }
                
                rawTextArea.value = text;
                
                // Debug applied positions extraction
                const appliedPositions = debugExtractAppliedPosition(text);
                
                debugOutput.textContent = `Applied Positions Result: "${appliedPositions}"`;
                
            } catch (error) {
                debugOutput.textContent = `Error: ${error.message}`;
            }
        });

        async function extractTextFromPDF(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    try {
                        const pdf = await pdfjsLib.getDocument({data: this.result}).promise;
                        let fullText = '';
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            const pageText = content.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n';
                        }
                        
                        resolve(fullText);
                    } catch (error) {
                        reject(error);
                    }
                };
                fileReader.onerror = () => reject(new Error('Lỗi đọc file PDF'));
                fileReader.readAsArrayBuffer(file);
            });
        }

        function debugExtractAppliedPosition(text) {
            console.log('=== DEBUG EXTRACTING APPLIED POSITION ===');
            
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            console.log(`Total lines: ${lines.length}`);
            
            const positions = [];
            let inAppliedSection = false;
            
            // Debug: tìm tất cả các dòng chứa "vị trí"
            console.log('Lines containing "vị trí":');
            lines.forEach((line, idx) => {
                if (line.toLowerCase().includes('vị trí')) {
                    console.log(`Line ${idx}: "${line}"`);
                }
            });
            
            console.log('\nLines containing "ứng tuyển":');
            lines.forEach((line, idx) => {
                if (line.toLowerCase().includes('ứng tuyển')) {
                    console.log(`Line ${idx}: "${line}"`);
                }
            });
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Mở rộng pattern để tìm tiêu đề "VỊ TRÍ ỨNG TUYỂN" 
                const appliedPositionPatterns = [
                    /^vị\s*trí\s*ứng\s*tuyển$/i,
                    /vị\s*trí\s*ứng\s*tuyển/i,  // Cho phép có text khác trong dòng
                    /^position\s*applied$/i,
                    /^applied\s*position$/i,
                    /ứng\s*tuyển.*vị\s*trí/i,
                    /vị\s*trí.*ứng\s*tuyển/i
                ];
                
                let foundAppliedSection = false;
                for (const pattern of appliedPositionPatterns) {
                    if (pattern.test(line)) {
                        console.log(`✓ Found "VỊ TRÍ ỨNG TUYỂN" section at line ${i}: "${line}"`);
                        inAppliedSection = true;
                        foundAppliedSection = true;
                        break;
                    }
                }
                
                if (foundAppliedSection) {
                    continue; // Skip the header line
                }
                
                if (inAppliedSection) {
                    console.log(`Processing line ${i} in applied section: "${line}"`);
                    
                    // Tìm các dòng bắt đầu bằng số (1. Marketing 2. Tổ chức nhân sự)
                    const numberedPattern = /^(\d+)\.\s*(.+)$/;
                    const match = line.match(numberedPattern);
                    
                    if (match) {
                        const position = `${match[1]}. ${match[2].trim()}`;
                        positions.push(position);
                        console.log(`✓ Found numbered position: ${position}`);
                    } else if (line && line.length > 2 && !/^(thông tin|skills|education|experience|học vấn|kinh nghiệm|giải thưởng|chứng chỉ)/i.test(line)) {
                        // Nếu không có số thì vẫn thêm vào nếu có nội dung hợp lý
                        positions.push(line);
                        console.log(`✓ Found non-numbered position: ${line}`);
                    }
                    
                    // Dừng khi gặp phần khác hoặc hết nội dung liên quan
                    if (/^(thông tin|skills|education|experience|học vấn|kinh nghiệm|giải thưởng|chứng chỉ)/i.test(line)) {
                        console.log(`Stopping applied section at line: "${line}"`);
                        break;
                    }
                }
            }
            
            const result = positions.length > 0 ? positions.join(' ') : '';
            console.log(`Final applied positions found: ${positions.length} items`);
            console.log('Applied positions:', positions);
            console.log(`Result: "${result}"`);
            
            return result;
        }
    </script>
</body>
</html>